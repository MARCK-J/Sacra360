@startuml Arquitectura del Sistema Sacra360
!theme plain
skinparam backgroundColor #FEFEFE
skinparam componentStyle rectangle

title Arquitectura de Microservicios - Sacra360

' =====================================
' CAPA DE PRESENTACIÓN
' =====================================

package "Capa de Presentación" <<Frontend>> #E3F2FD {
  component "React Application" as react {
    [Dashboard] as dashboard
    [Digitalización] as digitalizacion
    [Revisión OCR] as revision
    [Registros] as registros
    [Personas] as personas
    [Usuarios] as usuarios
    [Auditoría] as auditoria
    [Reportes] as reportes
    [Mi Perfil] as perfil
  }
  
  component "React Router" as router
  component "Axios HTTP Client" as axios
  component "Context API" as context {
    [AuthContext] as authContext
  }
  
  component "Vite Dev Server" as vite #FFE082
  
  note right of vite
    Puerto: 5173
    Build: Production optimizado
    HMR: Hot Module Replacement
  end note
}

' =====================================
' CAPA DE API GATEWAY
' =====================================

package "Capa de Gateway" <<Gateway>> #FFF9C4 {
  component "API Gateway" as gateway #FFD54F {
    [Enrutamiento] as routing
    [Load Balancer] as balancer
    [Rate Limiting] as ratelimit
    [CORS Handler] as cors
  }
  
  note right of gateway
    Puerto: 8000
    Framework: FastAPI/Express
    Responsabilidades:
    - Punto de entrada único
    - Autenticación centralizada
    - Balanceo de carga
    - Rate limiting global
  end note
}

' =====================================
' CAPA DE MICROSERVICIOS
' =====================================

package "Capa de Microservicios" <<Backend>> #C8E6C9 {
  
  component "AuthProfiles Service" as auth #81C784 {
    [Auth Router] as authRouter
    [Usuarios Router] as usersRouter
    [Auditoría Router] as auditRouter
    [Reportes Router] as reportesRouter
    [JWT Middleware] as jwtMiddleware
    [RBAC Middleware] as rbacMiddleware
    [Security Middleware] as secMiddleware
  }
  
  component "Documents Service" as docs #AED581 {
    [Sacramentos CRUD] as sacramCRUD
    [Personas CRUD] as personaCRUD
    [Búsqueda] as search
    [Validación] as validation
  }
  
  component "OCR Service" as ocr #C5E1A5 {
    [Tesseract Engine] as tesseract
    [Preprocesamiento] as preprocess
    [Extracción Campos] as extraction
    [Confidence Score] as confidence
  }
  
  component "HTR Service" as htr #DCEDC8 {
    [Modelo TensorFlow] as tfModel
    [Segmentación Líneas] as segmentation
    [Reconocimiento] as recognition
    [Post-procesamiento] as postprocess
  }
  
  component "AI Processing Service" as ai #E8F5E9 {
    [OpenAI Integration] as openai
    [NLP Processing] as nlp
    [Entity Recognition] as ner
    [Data Enhancement] as enhance
  }
  
  component "File Storage Service" as files #B2DFDB {
    [Upload Handler] as upload
    [MinIO Client] as minioClient
    [File Validation] as fileValid
    [URL Generator] as urlGen
  }
  
  component "Reports Service" as reportsvc #80CBC4 {
    [PDF Generator] as pdfGen
    [Excel Exporter] as excelExp
    [Charts Builder] as charts
    [Aggregations] as aggregations
  }
}

note right of auth
  Puerto: 8004
  Framework: FastAPI
  Base de datos: PostgreSQL
  Autenticación: JWT HS256
  RBAC: 144 permisos
  Rate Limit: 100 req/min
end note

note right of docs
  Puerto: 8002
  Framework: FastAPI
  ORM: SQLAlchemy
  Responsabilidad:
  - CRUD Sacramentos
  - CRUD Personas
  - Búsquedas avanzadas
end note

note right of ocr
  Puerto: 8003
  Framework: FastAPI
  Motor: Tesseract 5.x
  Idioma: Español
  Confianza mínima: 70%
end note

note right of htr
  Puerto: 8004
  Framework: FastAPI
  Modelo: Custom TensorFlow
  Especializado en:
  - Manuscritos antiguos
  - Caligrafía del siglo XIX-XX
end note

note right of files
  Puerto: 8007
  Storage: MinIO (S3)
  Formatos: JPG, PNG, PDF
  Max size: 10MB
end note

' =====================================
' CAPA DE PERSISTENCIA
' =====================================

package "Capa de Persistencia" <<Database>> #FFCCBC {
  
  database "PostgreSQL" as postgres #FF8A65 {
    [usuarios] as tblUsers
    [sacramentos] as tblSacr
    [documento_digitalizado] as tblDocs
    [ocr_resultado] as tblOCR
    [Auditoria] as tblAudit
    [14 Tablas Total] as allTables
  }
  
  database "Redis Cache" as redis #FF7043 {
    [Sessions] as sessions
    [Cache Reportes] as cacheReports
    [Rate Limit Counters] as rateLimitCache
  }
  
  database "MinIO Object Storage" as minio #FF5722 {
    [Bucket: sacra360] as bucket
    [Documentos Digitalizados] as storedDocs
    [Imágenes OCR] as ocrImages
  }
}

note right of postgres
  Motor: PostgreSQL 15
  Puerto: 5432
  Encoding: UTF-8
  Pool: 5-20 conexiones
  Backup: Diario 2:00 AM
end note

note right of redis
  Versión: 7 Alpine
  Puerto: 6379
  TTL Cache: 5 minutos
  Uso: Cache + Sessions
end note

note right of minio
  Compatible: S3 API
  Puerto: 9000 (API)
  Puerto: 9001 (Console)
  Acceso: minioadmin
end note

' =====================================
' CAPA DE INFRAESTRUCTURA
' =====================================

package "Capa de Infraestructura" <<Infrastructure>> #E1BEE7 {
  
  component "Docker Engine" as docker #BA68C8 {
    [Container Runtime] as runtime
    [Network Bridge] as network
    [Volume Manager] as volumes
  }
  
  component "Docker Compose" as compose #AB47BC {
    [Orchestrator] as orchestrator
    [Service Manager] as serviceManager
    [Network Config] as netConfig
  }
  
  node "sacra360_network" as dockerNet #9C27B0 {
    collections "Containers" {
      [sacra360-postgres]
      [sacra360_redis]
      [sacra360_minio]
      [sacra360_authprofiles_service]
      [sacra360_documents_service]
      [sacra360_ocr_service]
      [sacra360_htr_service]
      [sacra360_ai_service]
      [sacra360_files_service]
      [sacra360_reports_service]
    }
  }
}

note right of dockerNet
  Red: Bridge
  Subnet: 172.18.0.0/16
  DNS: Interno Docker
  Aislamiento: Container-level
end note

' =====================================
' RELACIONES Y FLUJOS
' =====================================

' Frontend -> Gateway
react --> gateway : HTTPS/REST
axios --> gateway : HTTP Requests
authContext --> gateway : JWT Token

' Gateway -> Microservicios
gateway --> auth : /api/v1/auth/*
gateway --> docs : /api/v1/sacramentos/*\n/api/v1/personas/*
gateway --> ocr : /api/v1/ocr/*
gateway --> htr : /api/v1/htr/*
gateway --> ai : /api/v1/ai/*
gateway --> files : /api/v1/files/*
gateway --> reportsvc : /api/v1/reports/*

' Microservicios -> Bases de datos
auth --> postgres : SQLAlchemy ORM
auth --> redis : Cache & Sessions
docs --> postgres : SQLAlchemy ORM
ocr --> postgres : Resultados OCR
htr --> postgres : Resultados HTR
files --> minio : S3 API
files --> postgres : Metadata
reportsvc --> postgres : Queries
reportsvc --> redis : Cache

' Microservicios entre sí
docs --> auth : Validar Token
ocr --> auth : Validar Token
ocr --> files : Obtener Imagen
htr --> files : Obtener Imagen
ai --> docs : Obtener Datos
reportsvc --> auth : Obtener Stats

' Infraestructura
compose --> docker : Gestiona
docker --> dockerNet : Ejecuta
dockerNet --> postgres : Container
dockerNet --> redis : Container
dockerNet --> minio : Container

' =====================================
' LEYENDA
' =====================================

legend right
  **Tecnologías Principales:**
  
  **Frontend:**
  - React 19.1 + Vite 7.1
  - React Router 7.9
  - Axios 1.13
  - Tailwind CSS 3.4
  
  **Backend:**
  - FastAPI 0.115
  - SQLAlchemy 2.0
  - Pydantic 2.10
  - Python 3.11+
  
  **Bases de Datos:**
  - PostgreSQL 15
  - Redis 7
  - MinIO (S3-compatible)
  
  **Infraestructura:**
  - Docker 24.x
  - Docker Compose 3.8
  
  **Seguridad:**
  - JWT (HS256)
  - bcrypt (12 rounds)
  - HTTPS/TLS
  - CORS configurado
  - Rate Limiting
  - Security Headers
end legend

@enduml
