@startuml Diagrama de Actividad - Flujo General del Sistema
!theme plain
skinparam backgroundColor #FEFEFE

title Diagrama de Actividad - Flujo General del Sistema Sacra360

start
:Acceder a Sacra360;
:Mostrar pantalla de login;
:Ingresar credenciales;
:Validar credenciales (AuthProfiles);

if (Credenciales válidas?) then (sí)
  :Generar JWT token;
  :Registrar login en auditoría;
  :Guardar token en localStorage;
  :Cargar permisos del usuario;
  :Redireccionar a Dashboard;
  :Ver Dashboard con módulos\nsegún permisos;
  
  repeat
    :Seleccionar módulo;
    :Verificar permisos locales;
    
    if (Tiene permisos?) then (sí)
      
      partition "Módulos Disponibles" {
        
        if (Módulo seleccionado?) then (Digitalización)
          :Subir documento;
          :Guardar en MinIO\n(File Storage Service);
          :Registrar en BD;
          :Procesar con Tesseract\n(OCR Service);
          :Extraer texto y campos;
          :Mostrar resultados;
          
        elseif (Revisión OCR)
          :Ver documentos pendientes;
          :Corregir campos erróneos;
          :Guardar correcciones\n(Documents Service);
          :Marcar como validado;
          
        elseif (Registros)
          :Buscar/crear sacramento;
          :Completar formulario;
          :Validar datos\n(Documents Service);
          :Crear persona (si es nueva);
          :Crear sacramento y detalles;
          :Vincular con documento;
          
        elseif (Usuarios)
          :Gestionar usuarios del sistema;
          if (Acción?) then (Crear)
            :Validar email único\n(AuthProfiles Service);
            :Hash contraseña con bcrypt;
            :Insertar en BD;
          elseif (Editar)
            :Actualizar datos;
          elseif (Desactivar)
            :Soft delete (activo=false);
          elseif (Reactivar)
            :Activar cuenta (activo=true);
          endif
          :Registrar en auditoría;
          
        elseif (Auditoría)
          :Ver logs del sistema;
          :Filtrar por usuario/fecha;
          :Consultar tabla auditoría\n(AuthProfiles Service);
          :Aplicar filtros;
          :Paginar resultados;
          
        elseif (Reportes)
          :Seleccionar período;
          :Verificar caché Redis\n(AuthProfiles Service);
          if (Existe en caché?) then (sí)
            :Devolver desde caché;
          else (no)
            :Ejecutar queries agregadas\n(PostgreSQL);
            :Calcular estadísticas;
            :Guardar en caché Redis (5 min);
          endif
          :Renderizar gráficos;
          :Mostrar métricas;
          
        elseif (Personas)
          :Buscar persona;
          :Ver sacramentos recibidos;
          :Consultar BD\n(Documents Service);
          :Listar sacramentos;
          
        elseif (Mi Perfil)
          :Ver información personal;
          :Cambiar contraseña;
          :Validar contraseña actual\n(AuthProfiles Service);
          :Hash nueva contraseña;
          :Actualizar en BD;
          
        endif
      }
      
      :Registrar acción en auditoría;
      :Devolver resultado;
      
    else (no)
      :Mostrar error de permisos;
    endif
    
  repeat while (Continuar usando el sistema?) is (sí)
  
  :Click "Cerrar Sesión";
  :Registrar logout en auditoría\n(AuthProfiles Service);
  :Limpiar localStorage;
  :Redireccionar a login;
  
else (no)
  :Registrar intento fallido;
  :Mostrar error;
  stop
endif

stop

@enduml
